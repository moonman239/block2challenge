<html>
    <head>
        <title>The Foodie Traveler</title>
        <script>
            var restaurants = [];
            var userPosition = undefined;
            const apiKey = "1167886aeemsh061eed0f807e535p17f6aajsnc70cd0d6bdaa";
            var userPosition = undefined;
            var sortingFunction = ratingFunction; // Specifies how the restaurants are to be sorted.
            function ratingFunction(x,y)
            {
                return (parseFloat(x.rating) > parseFloat(y.rating) || y.rating === undefined) ? -1 : 1;
            }
            function distanceFunction(x,y)
            {
                return (parseFloat(x.distance) < parseFloat(y.distance) || y.distance === undefined) ? -1 : 1;
            }
            function displayRestaurants()
            {
                restaurants = restaurants.sort(sortingFunction);
                const table = document.getElementById("restaurants");
                table.innerHTML = "";
                for (const i in restaurants)
                {
                    const name = restaurants[i].name;
                    if (name === undefined)
                    {
                        continue;
                    }
                    const nameHeader = "<h3>" + name + "</h3>";
                    const addressString = restaurants[i].address;
                    const description = restaurants[i].description;
                    const distance = restaurants[i].distance_string;
                    const rating = restaurants[i].rating;
                    let openNow = restaurants[i].open_now_text;
                    if (openNow === undefined)
                    {
                        openNow = "";
                    }
                    const priceText = restaurants[i].price_level;
                    const tr = document.createElement("tr");
                    tr.id = i;
                    const td1 = "<td>" + nameHeader + addressString + "<br><br>" + openNow + "<br><br>" + description + "</td>"
                    const td2 = "<td>" + distance + "</td>";
                    const td3 = "<td>" + rating + "</td>";
                    const td4 = "<td>" + priceText + "</td>";
                    tr.innerHTML = td1 + td2 + td3 + td4;
                    table.appendChild(tr);
                }
            }
            function fetchAndDisplayRestaurants()
            {
                let coords = userPosition;
                if (coords.latitude === undefined || coords.longitude === undefined)
                {
                    throw new Error("undefined coordinates.");
                }
                console.log(coords.latitude + " " + coords.longitude);
                let _fetch = fetch("https://travel-advisor.p.rapidapi.com/restaurants/list-by-latlng?latitude=" + coords.latitude + "&longitude=" + coords.longitude + "&currency=USD&open_now=false&lunit=mi&lang=en_US", {
                    "method": "GET",
                    "headers": {
                        "x-rapidapi-key": apiKey,
                        "x-rapidapi-host": "travel-advisor.p.rapidapi.com"
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        else {
                            return Promise.reject(response.statusText);
                        }});
                _fetch.catch(alert);
                _fetch.then(json => {
                    restaurants = json["data"];
                    console.log(restaurants);
                    displayRestaurants();
                })
            }
            function getLocation() {
                navigator.geolocation.getCurrentPosition(position => {
                    userPosition = position.coords;
                });
                document.getElementById("address").value = "Current Location";
            }
            async function geocodeAddress(address)
            {
                let response = await fetch("https://forward-reverse-geocoding.p.rapidapi.com/v1/search?q=" + address + "%20USA&format=json&accept-language=en&polygon_threshold=0.0", {
                    "method": "GET",
                    "headers": {
                        "x-rapidapi-key": apiKey,
                        "x-rapidapi-host": "forward-reverse-geocoding.p.rapidapi.com"
                    }
                })
                let json = await response.json();
                userPosition = {latitude: json[0].lat, longitude: json[0].lon};
                console.log("Geocoded position: " + userPosition.latitude + " " + userPosition.longitude);
            }
            function changeSort(select)
            {
                if (select.value === "rating")
                    sortingFunction = ratingFunction;
                else
                    sortingFunction = distanceFunction;
                displayRestaurants();
            }
            async function go() {
                if (document.getElementById("address").value !== "Current Location")
                   await geocodeAddress(document.getElementById("address").value);
                fetchAndDisplayRestaurants();
            }
        </script>
        <style>
            #header {
                position: fixed;
                top: 0px;
            }
            #restaurants {
                position:relative;
                top:50px;
            }
        </style>
    </head>
    <body>
        <div id="header">
        <input type="text" id="cuisine" placeholder="Cuisine"><input id="address" placeholder="Address"><button onclick="getLocation()" title="">Get Location</button>
        <button onclick="go()">Search</button>
        <select onchange="changeSort(this)">
            <option value="rating">Rating</option>
            <option value="distance">Distance</option>
        </select>
        </div>
        <table id="restaurants">
            </table>
    </body>
</html>