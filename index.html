<html>
    <head>
        <title>The Foodie Traveler</title>
        <script>
            var restaurants = [];
            var favorites = [];
            var userPosition = undefined;
           
            var userPosition = undefined;
            var sortingFunction = ratingFunction; // Specifies how the restaurants are to be sorted.
            var favoritesKey = "favorites";
            var displayFavorites = false; // True if the user specifies that they want the favorites to be displayed.
            if (!localStorage.getItem(favoritesKey))
                localStorage.setItem(favoritesKey,JSON.stringify([]));
            else
                favorites = JSON.parse(localStorage.getItem(favoritesKey));
            function ratingFunction(x,y)
            {
                return (parseFloat(x.rating) > parseFloat(y.rating) || y.rating === undefined) ? -1 : 1;
            }
            function distanceFunction(x,y)
            {
                return (parseFloat(x.distance) < parseFloat(y.distance) || y.distance === undefined) ? -1 : 1;
            }
            function viewFavorites()
            {
                console.log("Favorites: " + favorites);
                displayFavorites = true;
                displayRestaurants();
            }
            Array.prototype.indexOfRestaurant = function(restaurant)
            {
                return this.findIndex(x => x.location_id === restaurant.location_id);
            }
            function toggleFavorite(checkbox,restaurant)
            {
                const indexOfFavorite = favorites.indexOfRestaurant(restaurant);
                if (checkbox.checked)
                {
                    console.log("Favoriting restaurant.");
                    // Not favorited; add to favorites.
                    favorites.push(restaurant);
                }
                else
                {
                    // Favorited; remove from favorites.
                    favorites.splice(indexOfFavorite,1);
                }
                if (displayFavorites)
                {
                    displayRestaurants();
                }
                localStorage.setItem(favoritesKey,JSON.stringify(favorites));
            }
            function isFavorite(restaurant)
            {
                return favorites.indexOfRestaurant(restaurant) !== -1;
            }
            function displayRestaurants()
            {
                let restaurantArray = displayFavorites ? favorites : restaurants;
                console.log("Displaying array " + restaurantArray);
                restaurantArray = restaurantArray.sort(sortingFunction);
                const table = document.getElementById("restaurants");
                table.innerHTML = "";
                for (const i in restaurantArray)
                {
                    const name = restaurantArray[i].name;
                    if (name === undefined)
                    {
                        continue;
                    }
                    const nameHeader = "<h3>" + name + "</h3>";
                    const addressString = restaurantArray[i].address;
                    const description = restaurantArray[i].description;
                    const distance = restaurantArray[i].distance_string;
                    const rating = restaurantArray[i].rating;
                    let openNow = restaurantArray[i].open_now_text;
                    if (openNow === undefined)
                    {
                        openNow = "";
                    }
                    const priceText = restaurantArray[i].price_level;
                    const tr = document.createElement("tr");
                    const td1 = "<td>" + nameHeader + addressString + "<br><br>" + openNow + "<br><br>" + description + "</td>"
                    const td2 = "<td>" + distance + "</td>";
                    const td3 = "<td>" + rating + "</td>";
                    const td4 = "<td>" + priceText + "</td>";
                    const checked = isFavorite(restaurantArray[i]) ? "checked" : "";
                    const td5 = "<td><input type='checkbox' onchange='toggleFavorite(this,restaurants["+i+"])' " + checked +">";
                    tr.innerHTML = td1 + td2 + td3 + td4 + td5;
                    table.appendChild(tr);
                }
            }
            function fetchAndDisplayRestaurants()
            {
                displayFavorites = false;
                let coords = userPosition;
                if (coords.latitude === undefined || coords.longitude === undefined)
                {
                    throw new Error("undefined coordinates.");
                }
                console.log(coords.latitude + " " + coords.longitude);
                let _fetch = fetch("https://travel-advisor.p.rapidapi.com/restaurants/list-by-latlng?latitude=" + coords.latitude + "&longitude=" + coords.longitude + "&currency=USD&open_now=false&lunit=mi&lang=en_US", {
                    "method": "GET",
                    "headers": {
                        "x-rapidapi-key": apiKey,
                        "x-rapidapi-host": "travel-advisor.p.rapidapi.com"
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        else {
                            return Promise.reject(response.statusText);
                        }});
                _fetch.catch(alert);
                _fetch.then(json => {
                    restaurants = json["data"];
                    console.log(restaurants);
                    displayRestaurants();
                })
            }
            function getLocation() {
                document.getElementById("go").disabled = true;
                navigator.geolocation.getCurrentPosition(position => {
                    userPosition = position.coords;
                    document.getElementById("go").disabled = false;
                });
                document.getElementById("address").value = "Current Location";
            }
            async function geocodeAddress(address)
            {
                let response = await fetch("https://forward-reverse-geocoding.p.rapidapi.com/v1/search?q=" + address + "%20USA&format=json&accept-language=en&polygon_threshold=0.0", {
                    "method": "GET",
                    "headers": {
                        "x-rapidapi-key": apiKey,
                        "x-rapidapi-host": "forward-reverse-geocoding.p.rapidapi.com"
                    }
                })
                let json = await response.json();
                userPosition = {latitude: json[0].lat, longitude: json[0].lon};
                console.log("Geocoded position: " + userPosition.latitude + " " + userPosition.longitude);
            }
            function changeSort(select)
            {
                if (select.value === "rating")
                    sortingFunction = ratingFunction;
                else
                    sortingFunction = distanceFunction;
                displayRestaurants();
            }
            async function go() {
                if (document.getElementById("address").value !== "Current Location")
                   await geocodeAddress(document.getElementById("address").value);
                fetchAndDisplayRestaurants();
            }
        </script>
        <style>
            #header {
                position: fixed;
                top: 0px;
            }
            #restaurants {
                position:relative;
                top:50px;
            }
        </style>
    </head>
    <body>
        <div id="header">
        <input type="text" id="cuisine" placeholder="Cuisine"><input id="address" placeholder="Address"><button onclick="getLocation()" title="">Get Location</button>
        <button onclick="go()" id="go">Search</button>
        <select onchange="changeSort(this)">
            <option value="rating">Rating</option>
            <option value="distance">Distance</option>
        </select>
        <button onclick="viewFavorites()">View favorites</button>
        </div>
        <table id="restaurants">
            </table>
    </body>
</html>